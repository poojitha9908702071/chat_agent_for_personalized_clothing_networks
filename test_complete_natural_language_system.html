<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Natural Language Search System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { border-color: #4CAF50; background-color: #f0fff0; }
        .error { border-color: #f44336; background-color: #fff0f0; }
        .loading { border-color: #2196F3; background-color: #f0f8ff; }
        .warning { border-color: #ff9800; background-color: #fff8e1; }
        
        button {
            background: #e91e63;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #c2185b; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .query-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 16px;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            background: white;
            transition: transform 0.2s;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .product-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
        }
        .product-title {
            font-size: 14px;
            margin: 10px 0 5px 0;
            font-weight: bold;
            height: 40px;
            overflow: hidden;
        }
        .product-price {
            color: #e91e63;
            font-size: 16px;
            font-weight: bold;
        }
        .product-details {
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }
        .filters-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        .chat-simulation {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .chat-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
        }
        .user-message {
            background: #e3f2fd;
            text-align: right;
        }
        .bot-message {
            background: #f1f8e9;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #e91e63;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† Complete Natural Language Search System Test</h1>
        <p>Testing the full end-to-end natural language product search functionality after fixing the 404 error.</p>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalTests">0</div>
                <div class="stat-label">Total Tests</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="passedTests">0</div>
                <div class="stat-label">Passed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failedTests">0</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalProducts">0</div>
                <div class="stat-label">Products Found</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üéØ Predefined Query Tests</h2>
        <p>Testing various natural language queries to ensure proper filter extraction and product matching.</p>
        
        <button onclick="runAllPredefinedTests()">üöÄ Run All Predefined Tests</button>
        <button onclick="clearResults()">üßπ Clear Results</button>
        
        <div id="predefinedResults"></div>
    </div>

    <div class="container">
        <h2>üí¨ Interactive Query Tester</h2>
        <p>Test your own natural language queries:</p>
        
        <input type="text" class="query-input" id="customQuery" placeholder="Enter your natural language query (e.g., 'blue shirts for men under 2000')" />
        <button onclick="testCustomQuery()">üîç Test Query</button>
        
        <div id="customResults"></div>
    </div>

    <div class="container">
        <h2>üîÑ Follow-up Query Simulation</h2>
        <p>Testing context-aware follow-up queries:</p>
        
        <div class="chat-simulation" id="chatSimulation">
            <div class="chat-message user-message">Initial query will appear here...</div>
            <div class="chat-message bot-message">Bot response will appear here...</div>
        </div>
        
        <button onclick="simulateFollowUpFlow()">üé≠ Simulate Follow-up Flow</button>
        
        <div id="followUpResults"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let testStats = { total: 0, passed: 0, failed: 0, totalProducts: 0 };
        
        // Predefined test queries with expected behavior
        const testQueries = [
            {
                query: "blue shirts for men under 2000",
                expectedFilters: ["gender: Men", "product_category: shirts", "color: blue", "price_max: 2000"],
                description: "Complete query with gender, category, color, and price"
            },
            {
                query: "women dresses red color below 3000",
                expectedFilters: ["gender: Women", "product_category: dresses", "color: red", "price_max: 3000"],
                description: "Women's dresses with color and price filter"
            },
            {
                query: "black t-shirts for men",
                expectedFilters: ["gender: Men", "product_category: t-shirts", "color: black"],
                description: "Basic query with gender, category, and color"
            },
            {
                query: "party wear for women under 2500",
                expectedFilters: ["gender: Women", "category_group: Western Wear, Dresses", "price_max: 2500"],
                description: "Special category mapping (party wear)"
            },
            {
                query: "formal shirts above 1500",
                expectedFilters: ["category_group: Shirts", "price_min: 1500"],
                description: "Formal wear with minimum price"
            },
            {
                query: "ethnic wear for women",
                expectedFilters: ["gender: Women", "product_category: ethnic wear"],
                description: "Ethnic wear category"
            },
            {
                query: "green hoodies size L",
                expectedFilters: ["product_category: hoodies", "color: green", "size: L"],
                description: "Category with color and size"
            },
            {
                query: "western wear between 1000 and 3000",
                expectedFilters: ["product_category: western wear", "price_min: 1000", "price_max: 3000"],
                description: "Price range query"
            }
        ];
        
        function updateStats() {
            document.getElementById('totalTests').textContent = testStats.total;
            document.getElementById('passedTests').textContent = testStats.passed;
            document.getElementById('failedTests').textContent = testStats.failed;
            document.getElementById('totalProducts').textContent = testStats.totalProducts;
        }
        
        function addTestResult(containerId, title, status, message, products = []) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-section ${status}`;
            
            let productDisplay = '';
            if (products && products.length > 0) {
                testStats.totalProducts += products.length;
                productDisplay = displayProducts(products);
            }
            
            resultDiv.innerHTML = `
                <h3>${title}</h3>
                <div>${message}</div>
                ${productDisplay}
            `;
            
            container.appendChild(resultDiv);
            
            // Update stats
            testStats.total++;
            if (status === 'success') testStats.passed++;
            else if (status === 'error') testStats.failed++;
            updateStats();
        }
        
        function displayProducts(products) {
            if (!products || products.length === 0) {
                return '<p><em>No products found</em></p>';
            }
            
            let html = `<div class="product-grid">`;
            products.slice(0, 6).forEach(product => {
                html += `
                    <div class="product-card">
                        <img src="${product.image_url || '/placeholder.jpg'}" 
                             alt="${product.title}" 
                             class="product-image"
                             onerror="this.src='/placeholder.jpg'">
                        <div class="product-title">${product.title}</div>
                        <div class="product-price">‚Çπ${product.price}</div>
                        <div class="product-details">
                            ${product.color || 'N/A'} | ${product.gender || 'Unisex'}<br>
                            ${product.category || 'Fashion'}
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            
            if (products.length > 6) {
                html += `<p><em>Showing 6 of ${products.length} products</em></p>`;
            }
            
            return html;
        }
        
        async function testNaturalLanguageQuery(query, expectedFilters = [], description = '') {
            try {
                console.log(`Testing query: "${query}"`);
                
                const response = await fetch(`${API_BASE}/products/search-natural`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Query result:', data);
                
                // Analyze filters
                const appliedFilters = data.filters_applied || {};
                const filterStrings = Object.entries(appliedFilters).map(([key, value]) => {
                    if (Array.isArray(value)) {
                        return `${key}: ${value.join(', ')}`;
                    }
                    return `${key}: ${value}`;
                });
                
                const message = `
                    <p><strong>Query:</strong> "${query}"</p>
                    <p><strong>Description:</strong> ${description}</p>
                    <div class="filters-display">
                        <strong>Filters Applied:</strong><br>
                        ${filterStrings.length > 0 ? filterStrings.join('<br>') : 'None'}
                    </div>
                    <p><strong>Results:</strong> ${data.count} products found</p>
                    ${data.message ? `<p><em>${data.message}</em></p>` : ''}
                `;
                
                return {
                    success: true,
                    message,
                    products: data.products || [],
                    filters: appliedFilters,
                    count: data.count
                };
                
            } catch (error) {
                console.error('Query test error:', error);
                return {
                    success: false,
                    message: `<p><strong>Error:</strong> ${error.message}</p>`,
                    products: [],
                    filters: {},
                    count: 0
                };
            }
        }
        
        async function runAllPredefinedTests() {
            document.getElementById('predefinedResults').innerHTML = '';
            
            for (let i = 0; i < testQueries.length; i++) {
                const test = testQueries[i];
                const result = await testNaturalLanguageQuery(test.query, test.expectedFilters, test.description);
                
                const title = `Test ${i + 1}: ${test.description}`;
                const status = result.success ? 'success' : 'error';
                
                addTestResult('predefinedResults', title, status, result.message, result.products);
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }
        
        async function testCustomQuery() {
            const query = document.getElementById('customQuery').value.trim();
            if (!query) {
                alert('Please enter a query to test');
                return;
            }
            
            document.getElementById('customResults').innerHTML = '';
            
            const result = await testNaturalLanguageQuery(query, [], 'Custom user query');
            const status = result.success ? 'success' : 'error';
            
            addTestResult('customResults', `Custom Query Test`, status, result.message, result.products);
        }
        
        async function simulateFollowUpFlow() {
            document.getElementById('followUpResults').innerHTML = '';
            const chatDiv = document.getElementById('chatSimulation');
            
            // Step 1: Initial query
            chatDiv.innerHTML = `
                <div class="chat-message user-message">"Show me shirts for men"</div>
                <div class="chat-message bot-message">Searching for shirts for men...</div>
            `;
            
            const initialResult = await testNaturalLanguageQuery('shirts for men', [], 'Initial query in follow-up flow');
            
            if (initialResult.success) {
                chatDiv.innerHTML += `
                    <div class="chat-message bot-message">Found ${initialResult.count} shirts for men. Here are some options:</div>
                `;
                
                // Step 2: Follow-up query
                setTimeout(async () => {
                    chatDiv.innerHTML += `
                        <div class="chat-message user-message">"Show under 1500"</div>
                        <div class="chat-message bot-message">Filtering previous results under ‚Çπ1500...</div>
                    `;
                    
                    const followUpResult = await fetch(`${API_BASE}/products/search-natural`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: 'show under 1500',
                            override_filters: {
                                gender: 'Men',
                                product_category: 'shirts',
                                price_max: 1500
                            }
                        })
                    });
                    
                    if (followUpResult.ok) {
                        const followUpData = await followUpResult.json();
                        
                        chatDiv.innerHTML += `
                            <div class="chat-message bot-message">Perfect! Found ${followUpData.count} shirts for men under ‚Çπ1500.</div>
                        `;
                        
                        const message = `
                            <p><strong>Follow-up Flow Test:</strong></p>
                            <p>Initial query: "shirts for men" ‚Üí ${initialResult.count} products</p>
                            <p>Follow-up: "show under 1500" ‚Üí ${followUpData.count} products</p>
                            <div class="filters-display">
                                <strong>Final Filters:</strong><br>
                                gender: Men<br>
                                product_category: shirts<br>
                                price_max: 1500
                            </div>
                        `;
                        
                        addTestResult('followUpResults', 'Follow-up Query Flow', 'success', message, followUpData.products);
                    } else {
                        addTestResult('followUpResults', 'Follow-up Query Flow', 'error', 'Follow-up query failed');
                    }
                }, 2000);
            } else {
                addTestResult('followUpResults', 'Follow-up Query Flow', 'error', 'Initial query failed');
            }
        }
        
        function clearResults() {
            document.getElementById('predefinedResults').innerHTML = '';
            document.getElementById('customResults').innerHTML = '';
            document.getElementById('followUpResults').innerHTML = '';
            testStats = { total: 0, passed: 0, failed: 0, totalProducts: 0 };
            updateStats();
        }
        
        // Auto-run a quick test on page load
        window.onload = function() {
            setTimeout(() => {
                testNaturalLanguageQuery('blue shirts for men', [], 'Quick system check').then(result => {
                    if (result.success) {
                        addTestResult('predefinedResults', 'System Status Check ‚úÖ', 'success', 
                            `System is working! Found ${result.count} products for "blue shirts for men".`);
                    } else {
                        addTestResult('predefinedResults', 'System Status Check ‚ùå', 'error', 
                            'System check failed. Please ensure backend is running.');
                    }
                });
            }, 1000);
        };
    </script>
</body>
</html>