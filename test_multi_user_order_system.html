<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-User Order System - Complete Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #ec4899, #f97316);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }
        .user-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .button {
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .button:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        .button.secondary {
            background: #3b82f6;
        }
        .button.secondary:hover {
            background: #1d4ed8;
        }
        .status {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .success { background: rgba(16, 185, 129, 0.3); }
        .error { background: rgba(239, 68, 68, 0.3); }
        .info { background: rgba(59, 130, 246, 0.3); }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõçÔ∏è Multi-User Order System - Complete Test</h1>
        
        <div class="status success">
            <h3>‚úÖ System Status: READY</h3>
            <p><strong>Users Setup:</strong> 5 users with multiple orders each</p>
            <p><strong>Order Statuses:</strong> pending, confirmed, processing, shipped, delivered</p>
            <p><strong>Cancellation:</strong> Available for pending/confirmed/processing orders</p>
            <p><strong>User Isolation:</strong> Each user sees only their own orders</p>
        </div>
    </div>

    <div class="container">
        <h2>üë• Test Users & Their Orders</h2>
        
        <div class="grid" id="userGrid">
            <!-- Users will be populated here -->
        </div>
    </div>

    <div class="container">
        <h2>üß™ Testing Instructions</h2>
        
        <div class="status info">
            <h3>üìã How to Test Each User:</h3>
            <ol>
                <li><strong>Click "Login as [User]"</strong> - Sets authentication for that user</li>
                <li><strong>Open Chat</strong> - Click the pink chat button in bottom right</li>
                <li><strong>Ask "show my orders"</strong> - Should show only that user's orders</li>
                <li><strong>Test Cancellation</strong> - Click "Cancel Order" on eligible orders</li>
                <li><strong>Verify Isolation</strong> - Switch users and confirm no data mixing</li>
            </ol>
        </div>

        <div class="status success">
            <h3>‚úÖ Expected Results:</h3>
            <ul>
                <li><strong>User Isolation:</strong> Each user sees only their orders</li>
                <li><strong>Order Display:</strong> Interactive cards with product details</li>
                <li><strong>Cancellation:</strong> Only available for pending/confirmed/processing orders</li>
                <li><strong>Status Updates:</strong> Real-time status changes after cancellation</li>
                <li><strong>Refund Message:</strong> Professional cancellation confirmation</li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h2>üîß Advanced Testing</h2>
        
        <button class="button secondary" onclick="testAllUsersAPI()">Test All Users API</button>
        <button class="button secondary" onclick="testCancellationFlow()">Test Cancellation Flow</button>
        <button class="button secondary" onclick="verifyUserIsolation()">Verify User Isolation</button>
        
        <div id="advancedResults" class="status"></div>
    </div>

    <script>
        const users = [
            {
                name: "Poojitha Test",
                email: "poojitha@example.com",
                token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxNiwiZW1haWwiOiJwb29qaXRoYUBleGFtcGxlLmNvbSIsImV4cCI6MTc2ODE0NTc0M30.3V7uWggtFeArkqq2-0VGS3Io7stXX8lhdyipVaqMztI",
                orders: "2 orders, ‚Çπ11,094 total"
            },
            {
                name: "Nithya Test", 
                email: "nithya@example.com",
                token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxNywiZW1haWwiOiJuaXRoeWFAZXhhbXBsZS5jb20iLCJleHAiOjE3NjgxNDU3NDN9.iPoIcAfOQ3cPjX4Ig30wTqtW0P4Sv8PtlRAdFtycXXI",
                orders: "3 orders, ‚Çπ10,736 total"
            },
            {
                name: "Test User",
                email: "test@example.com", 
                token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxOCwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIiwiZXhwIjoxNzY4MTQ1NzQzfQ.IEikrak95kZeONFEIZJMB-Qg10l7nTZHjyQy6c0m7Po",
                orders: "3 orders, ‚Çπ13,876 total"
            },
            {
                name: "Poojitha Aggarapu",
                email: "poojitha@gmail.com",
                token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxOSwiZW1haWwiOiJwb29qaXRoYUBnbWFpbC5jb20iLCJleHAiOjE3NjgxNDU3NDN9.AvtOZD2l7lfZg-V7vqh3fHiSMtxxBPYJioBJEVVL2rA",
                orders: "4 orders, ‚Çπ11,835 total"
            },
            {
                name: "Sunitha",
                email: "sunitha@gmail.com",
                token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoyMCwiZW1haWwiOiJzdW5pdGhhQGdtYWlsLmNvbSIsImV4cCI6MTc2ODE0NTc0M30.hj7LuN0NGUsKxkGf0Q5yOPlZYAqlI_G7PfXChAZUN8s",
                orders: "4 orders, ‚Çπ13,977 total"
            }
        ];

        function renderUsers() {
            const grid = document.getElementById('userGrid');
            
            grid.innerHTML = users.map(user => `
                <div class="user-card">
                    <h3>üë§ ${user.name}</h3>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Orders:</strong> ${user.orders}</p>
                    
                    <div style="margin-top: 15px;">
                        <button class="button" onclick="loginAsUser('${user.email}', '${user.token}')">
                            Login as ${user.name.split(' ')[0]}
                        </button>
                        <button class="button secondary" onclick="testUserOrders('${user.email}', '${user.token}')">
                            Test Orders API
                        </button>
                    </div>
                    
                    <div id="status-${user.email.replace('@', '-').replace('.', '-')}" class="status" style="display: none;"></div>
                </div>
            `).join('');
        }

        function loginAsUser(email, token) {
            localStorage.setItem('authToken', token);
            localStorage.setItem('user_email', email);
            
            const statusId = `status-${email.replace('@', '-').replace('.', '-')}`;
            const statusDiv = document.getElementById(statusId);
            
            statusDiv.style.display = 'block';
            statusDiv.className = 'status success';
            statusDiv.innerHTML = `
                <h4>‚úÖ Logged in as ${email}</h4>
                <p><strong>Status:</strong> Authentication set</p>
                <p><strong>Next:</strong> Open chat and ask "show my orders"</p>
                <p><strong>Chat Location:</strong> Pink button in bottom right corner</p>
            `;
            
            // Highlight current user
            document.querySelectorAll('.user-card').forEach(card => {
                card.style.border = '2px solid rgba(255, 255, 255, 0.3)';
            });
            
            statusDiv.parentElement.style.border = '2px solid #10b981';
        }

        async function testUserOrders(email, token) {
            const statusId = `status-${email.replace('@', '-').replace('.', '-')}`;
            const statusDiv = document.getElementById(statusId);
            
            statusDiv.style.display = 'block';
            statusDiv.className = 'status info';
            statusDiv.innerHTML = '<h4>üîÑ Testing orders API...</h4>';
            
            try {
                const response = await fetch('http://localhost:5000/api/user/orders', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const orders = data.orders || [];
                    
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = `
                        <h4>‚úÖ API Test Success</h4>
                        <p><strong>Orders Found:</strong> ${orders.length}</p>
                        <p><strong>Total Value:</strong> ‚Çπ${orders.reduce((sum, order) => sum + parseFloat(order.total_amount), 0).toLocaleString()}</p>
                        <p><strong>Statuses:</strong> ${[...new Set(orders.map(o => o.order_status))].join(', ')}</p>
                        <p><strong>Cancellable:</strong> ${orders.filter(o => ['pending', 'confirmed', 'processing'].includes(o.order_status)).length} orders</p>
                    `;
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = `
                        <h4>‚ùå API Test Failed</h4>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Error:</strong> ${await response.text()}</p>
                    `;
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `
                    <h4>‚ùå Connection Error</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Check:</strong> Backend server running on port 5000?</p>
                `;
            }
        }

        async function testAllUsersAPI() {
            const resultsDiv = document.getElementById('advancedResults');
            resultsDiv.className = 'status info';
            resultsDiv.innerHTML = '<h4>üîÑ Testing all users API...</h4>';
            
            const results = [];
            
            for (const user of users) {
                try {
                    const response = await fetch('http://localhost:5000/api/user/orders', {
                        headers: {
                            'Authorization': `Bearer ${user.token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        results.push({
                            user: user.name,
                            email: user.email,
                            success: true,
                            orders: data.orders?.length || 0,
                            total: data.orders?.reduce((sum, order) => sum + parseFloat(order.total_amount), 0) || 0
                        });
                    } else {
                        results.push({
                            user: user.name,
                            email: user.email,
                            success: false,
                            error: response.status
                        });
                    }
                } catch (error) {
                    results.push({
                        user: user.name,
                        email: user.email,
                        success: false,
                        error: error.message
                    });
                }
            }
            
            const successCount = results.filter(r => r.success).length;
            const totalOrders = results.filter(r => r.success).reduce((sum, r) => sum + r.orders, 0);
            
            resultsDiv.className = 'status success';
            resultsDiv.innerHTML = `
                <h4>‚úÖ All Users API Test Complete</h4>
                <p><strong>Success Rate:</strong> ${successCount}/${users.length} users</p>
                <p><strong>Total Orders:</strong> ${totalOrders} across all users</p>
                <div style="margin-top: 10px;">
                    ${results.map(r => `
                        <div style="margin: 5px 0;">
                            ${r.success ? '‚úÖ' : '‚ùå'} ${r.user}: ${r.success ? `${r.orders} orders, ‚Çπ${r.total.toLocaleString()}` : `Error: ${r.error}`}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function testCancellationFlow() {
            const resultsDiv = document.getElementById('advancedResults');
            resultsDiv.className = 'status info';
            resultsDiv.innerHTML = '<h4>üîÑ Testing cancellation flow...</h4>';
            
            // Test with Nithya (has pending order)
            const nithya = users.find(u => u.email === 'nithya@example.com');
            
            try {
                const response = await fetch('http://localhost:5000/api/user/orders', {
                    headers: {
                        'Authorization': `Bearer ${nithya.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const cancellableOrders = data.orders?.filter(o => 
                        ['pending', 'confirmed', 'processing'].includes(o.order_status)
                    ) || [];
                    
                    resultsDiv.className = 'status success';
                    resultsDiv.innerHTML = `
                        <h4>‚úÖ Cancellation Flow Ready</h4>
                        <p><strong>Test User:</strong> ${nithya.name} (${nithya.email})</p>
                        <p><strong>Cancellable Orders:</strong> ${cancellableOrders.length}</p>
                        <div style="margin-top: 10px;">
                            ${cancellableOrders.map(order => `
                                <div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                                    Order #${order.order_id} - Status: ${order.order_status} - ‚Çπ${order.total_amount}
                                </div>
                            `).join('')}
                        </div>
                        <p><strong>To Test:</strong> Login as Nithya, open chat, ask "show my orders", click "Cancel Order"</p>
                    `;
                } else {
                    resultsDiv.className = 'status error';
                    resultsDiv.innerHTML = `<h4>‚ùå Failed to fetch orders for cancellation test</h4>`;
                }
            } catch (error) {
                resultsDiv.className = 'status error';
                resultsDiv.innerHTML = `<h4>‚ùå Cancellation test error: ${error.message}</h4>`;
            }
        }

        async function verifyUserIsolation() {
            const resultsDiv = document.getElementById('advancedResults');
            resultsDiv.className = 'status info';
            resultsDiv.innerHTML = '<h4>üîÑ Verifying user isolation...</h4>';
            
            const isolationResults = [];
            
            // Test each user's orders
            for (const user of users) {
                try {
                    const response = await fetch('http://localhost:5000/api/user/orders', {
                        headers: {
                            'Authorization': `Bearer ${user.token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const orders = data.orders || [];
                        
                        // Check if all orders belong to this user
                        const allOrdersBelongToUser = orders.every(order => 
                            order.user_email === user.email
                        );
                        
                        isolationResults.push({
                            user: user.name,
                            email: user.email,
                            orders: orders.length,
                            isolated: allOrdersBelongToUser,
                            orderEmails: [...new Set(orders.map(o => o.user_email))]
                        });
                    }
                } catch (error) {
                    isolationResults.push({
                        user: user.name,
                        email: user.email,
                        error: error.message
                    });
                }
            }
            
            const allIsolated = isolationResults.every(r => r.isolated);
            
            resultsDiv.className = allIsolated ? 'status success' : 'status error';
            resultsDiv.innerHTML = `
                <h4>${allIsolated ? '‚úÖ' : '‚ùå'} User Isolation ${allIsolated ? 'VERIFIED' : 'FAILED'}</h4>
                <div style="margin-top: 10px;">
                    ${isolationResults.map(r => `
                        <div style="margin: 5px 0;">
                            ${r.isolated ? '‚úÖ' : '‚ùå'} ${r.user}: ${r.orders} orders ${r.isolated ? '(properly isolated)' : '(ISOLATION BREACH!)'}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Initialize
        window.onload = function() {
            renderUsers();
        };
    </script>
</body>
</html>